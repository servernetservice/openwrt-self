name: Build OpenWrt 24.10 f

on:
  workflow_dispatch: # 手动触发编译

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 检查分支
      uses: actions/checkout@v4

    - name: 彻底清理磁盘空间
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        swap: true

    - name: 安装编译依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex g++ gawk gcc-multilib gettext \
        git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev swig \
        libpython3-dev libelf-dev zstd bc subversion qemu-utils

    - name: 克隆源码
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: 添加第三方插件源 (kenzo & small & small-package)
      run: |
        cd openwrt
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small" >> feeds.conf.default
        echo "src-git small_package https://github.com/kenzok8/small-package" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 注入完整配置 (.config)
      run: |
        cd openwrt
        # --- 基础架构与 GRUB 引导 ---
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "CONFIG_GRUB_IMAGES=y" >> .config
        echo "CONFIG_GRUB_EFI_IMAGES=y" >> .config

        # --- 增加 LUCI 基础界面 ---
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config

        # --- 插件: ADG, SmartDNS, Cloudflare DDNS, 多拨 (SyncDial) ---
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        echo "CONFIG_PACKAGE_ddns-scripts-cloudflare=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
        
        # --- 驱动: Intel E1000/E1000E/IGB & USB 网卡 ---
        echo "CONFIG_PACKAGE_kmod-e1000=y" >> .config
        echo "CONFIG_PACKAGE_kmod-e1000e=y" >> .config
        echo "CONFIG_PACKAGE_kmod-igb=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-asix=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-asix-ax88179=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-rtl8152=y" >> .config
        
        # --- 语言包: 全中文支持 ---
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-adguardhome-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-ddns-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-syncdial-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-mwan3-zh-cn=y" >> .config

        # --- 分区扩容 ---
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=64" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> .config
        
        # 应用并补全配置
        make defconfig

    - name: 预下载依赖包
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: 开始编译
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s

    - name: 整理并上传所有固件
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_x86_64_24.10_Firmware
        path: openwrt/bin/targets/x86/64/
