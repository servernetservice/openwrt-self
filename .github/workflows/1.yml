name: Build OpenWrt 24.10 3

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 检查分支
      uses: actions/checkout@v4

    - name: 彻底清理磁盘空间
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        swap: true

    - name: 安装编译依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex g++ gawk gcc-multilib gettext \
        git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev swig \
        libpython3-dev libelf-dev python3-setuptools

    - name: 克隆源码
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: 添加第三方插件源 (PassWall & Apps)
      run: |
        cd openwrt
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        # 已更换为 small-package
        echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 注入完整配置 (.config)
      run: |
        cd openwrt
        # 1. 强制启用 LuCI 界面及中文
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        
        # 2. Target 架构 (x86_64)
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "CONFIG_GRUB_IMAGES=y" >> .config
        echo "CONFIG_GRUB_EFI_IMAGES=y" >> .config
        
        # 3. 网络插件 (多拨/DNS/广告拦截)
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        echo "CONFIG_PACKAGE_ddns-scripts-cloudflare=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config

        # 4. PassWall 客户端及服务端
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Client=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Server=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Server=y" >> .config
        
        # 5. 网卡驱动适配 (物理机/虚拟化)
        echo "CONFIG_PACKAGE_kmod-e1000=y" >> .config
        echo "CONFIG_PACKAGE_kmod-e1000e=y" >> .config
        echo "CONFIG_PACKAGE_kmod-igb=y" >> .config
        echo "CONFIG_PACKAGE_kmod-r8169=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-rtl8152=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-asix-ax88179=y" >> .config
        
        # 6. 汉化语言包
        echo "CONFIG_PACKAGE_luci-i18n-adguardhome-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-ddns-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-syncdial-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-mwan3-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y" >> .config
        
        make defconfig

    - name: 预下载依赖
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: 开始编译
      run: |
        cd openwrt
        # 使用 CPU 核心数进行加速
        make -j$(nproc) || make -j1 V=s

    - name: 整理并上传固件
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_x86_64_24.10_SmallPkg
        path: |
          openwrt/bin/targets/x86/64/*combined-efi.img.gz
          openwrt/bin/targets/x86/64/*generic-rootfs.tar.gz
